# =============================================================================
# WORKFLOW D√âPLOIEMENT - MEDICONNET
# =============================================================================
# Ce workflow g√®re le d√©ploiement automatique de l'application vers les
# environnements de staging et production.
#
# Environnements:
# - Staging: D√©ploiement automatique sur push vers develop
# - Production: D√©ploiement manuel avec approbation sur push vers main
#
# Pr√©requis:
# - Configurer les secrets GitHub pour chaque environnement
# - Configurer les environnements dans Settings > Environments
# =============================================================================

name: Deploy

# D√©clencheurs du workflow
on:
  push:
    branches:
      - main      # D√©clenche le d√©ploiement production
      - develop   # D√©clenche le d√©ploiement staging
  workflow_dispatch:
    # Permet de d√©clencher manuellement le workflow
    inputs:
      environment:
        description: 'Environnement cible'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

# Variables d'environnement globales
# Note: github.repository_owner est automatiquement en minuscules
env:
  REGISTRY: ghcr.io
  FRONTEND_IMAGE: ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}-frontend
  BACKEND_IMAGE: ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}-backend

jobs:
  # ===========================================================================
  # JOB: BUILD - Construction des images Docker
  # ===========================================================================
  # Construit et pousse les images Docker vers le registry
  # ===========================================================================
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      # Exporte le tag de l'image pour les jobs suivants
      image_tag: ${{ steps.meta.outputs.version }}

    steps:
      # -----------------------------------------------------------------------
      # √âtape 1: R√©cup√©ration du code source
      # -----------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # √âtape 2: Configuration de Docker Buildx
      # Buildx permet des builds multi-plateformes et le cache avanc√©
      # -----------------------------------------------------------------------
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -----------------------------------------------------------------------
      # √âtape 3: Connexion au GitHub Container Registry
      # Utilise le token GitHub pour l'authentification
      # -----------------------------------------------------------------------
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------------------------------------------------
      # √âtape 4: Extraction des m√©tadonn√©es pour le tagging
      # G√©n√®re automatiquement les tags bas√©s sur la branche/commit
      # -----------------------------------------------------------------------
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.FRONTEND_IMAGE }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      # -----------------------------------------------------------------------
      # √âtape 5: Build et push de l'image Frontend
      # -----------------------------------------------------------------------
      - name: Build and push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./Mediconnet-Frontend
          push: true
          tags: |
            ${{ env.FRONTEND_IMAGE }}:${{ steps.meta.outputs.version }}
            ${{ env.FRONTEND_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # -----------------------------------------------------------------------
      # √âtape 6: Build et push de l'image Backend
      # -----------------------------------------------------------------------
      - name: Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./Mediconnet-Backend
          push: true
          tags: |
            ${{ env.BACKEND_IMAGE }}:${{ steps.meta.outputs.version }}
            ${{ env.BACKEND_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================================================
  # JOB: DEPLOY STAGING - D√©ploiement vers l'environnement de staging
  # ===========================================================================
  # D√©ploie automatiquement sur staging pour la branche develop
  # ===========================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build  # Attend que le build soit termin√©
    # Condition: uniquement sur la branche develop ou d√©clenchement manuel
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    
    # Environnement GitHub avec protection optionnelle
    environment:
      name: staging
      url: https://staging.mediconnet.example.com  # URL de l'environnement

    steps:
      # -----------------------------------------------------------------------
      # √âtape 1: R√©cup√©ration du code source
      # -----------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # √âtape 2: Configuration SSH pour le d√©ploiement
      # Utilise une cl√© SSH stock√©e dans les secrets GitHub
      # -----------------------------------------------------------------------
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.STAGING_SSH_KEY }}
        continue-on-error: true

      # -----------------------------------------------------------------------
      # √âtape 3: D√©ploiement via SSH
      # Se connecte au serveur et met √† jour les conteneurs Docker
      # -----------------------------------------------------------------------
      - name: Deploy to staging server
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
        if: env.STAGING_HOST != ''
        run: |
          echo "üöÄ D√©ploiement vers staging..."
          echo "Image tag: ${{ github.sha }}"
          
          # Exemple de commande de d√©ploiement SSH
          # ssh ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << 'EOF'
          #   cd /opt/mediconnet
          #   docker-compose pull
          #   docker-compose up -d
          # EOF
          
          echo "‚úÖ D√©ploiement staging simul√© (configurer les secrets pour activer)"
        continue-on-error: true

      # -----------------------------------------------------------------------
      # √âtape 4: Notification du d√©ploiement
      # -----------------------------------------------------------------------
      - name: Deployment notification
        run: |
          echo "üì¶ D√©ploiement Staging termin√©"
          echo "üîó Frontend: ${{ env.FRONTEND_IMAGE }}:${{ github.sha }}"
          echo "üîó Backend: ${{ env.BACKEND_IMAGE }}:${{ github.sha }}"
          echo "üåê URL: https://staging.mediconnet.example.com"

  # ===========================================================================
  # JOB: DEPLOY PRODUCTION - D√©ploiement vers l'environnement de production
  # ===========================================================================
  # D√©ploie sur production avec approbation manuelle requise
  # ===========================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build  # Attend que le build soit termin√©
    # Condition: uniquement sur la branche main ou d√©clenchement manuel
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    
    # Environnement GitHub avec protection (approbation requise)
    # Configurer dans Settings > Environments > production > Required reviewers
    environment:
      name: production
      url: https://mediconnet.example.com  # URL de production

    steps:
      # -----------------------------------------------------------------------
      # √âtape 1: R√©cup√©ration du code source
      # -----------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # √âtape 2: V√©rification pr√©-d√©ploiement
      # S'assure que toutes les conditions sont remplies
      # -----------------------------------------------------------------------
      - name: Pre-deployment checks
        run: |
          echo "üîç V√©rifications pr√©-d√©ploiement..."
          echo "‚úÖ Branche: ${{ github.ref_name }}"
          echo "‚úÖ Commit: ${{ github.sha }}"
          echo "‚úÖ Auteur: ${{ github.actor }}"

      # -----------------------------------------------------------------------
      # √âtape 3: Configuration SSH pour le d√©ploiement
      # -----------------------------------------------------------------------
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PRODUCTION_SSH_KEY }}
        continue-on-error: true

      # -----------------------------------------------------------------------
      # √âtape 4: D√©ploiement vers production
      # -----------------------------------------------------------------------
      - name: Deploy to production server
        env:
          PRODUCTION_HOST: ${{ secrets.PRODUCTION_HOST }}
        if: env.PRODUCTION_HOST != ''
        run: |
          echo "üöÄ D√©ploiement vers production..."
          echo "Image tag: ${{ github.sha }}"
          
          # Exemple de commande de d√©ploiement SSH
          # ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'EOF'
          #   cd /opt/mediconnet
          #   
          #   # Backup de la base de donn√©es avant d√©ploiement
          #   docker exec mediconnet-mysql mysqldump -u root -p$MYSQL_ROOT_PASSWORD mediconnet > backup_$(date +%Y%m%d_%H%M%S).sql
          #   
          #   # Pull des nouvelles images
          #   docker-compose pull
          #   
          #   # D√©ploiement avec zero-downtime
          #   docker-compose up -d --no-deps --scale frontend=2 frontend
          #   sleep 10
          #   docker-compose up -d --no-deps --scale frontend=1 frontend
          #   
          #   docker-compose up -d --no-deps backend
          # EOF
          
          echo "‚úÖ D√©ploiement production simul√© (configurer les secrets pour activer)"
        continue-on-error: true

      # -----------------------------------------------------------------------
      # √âtape 5: V√©rification post-d√©ploiement (Health Check)
      # -----------------------------------------------------------------------
      - name: Post-deployment health check
        run: |
          echo "üè• V√©rification de sant√© post-d√©ploiement..."
          
          # Exemple de health check
          # curl -f https://mediconnet.example.com/api/health || exit 1
          
          echo "‚úÖ Health check simul√© (configurer l'URL pour activer)"
        continue-on-error: true

      # -----------------------------------------------------------------------
      # √âtape 6: Notification du d√©ploiement
      # -----------------------------------------------------------------------
      - name: Deployment notification
        run: |
          echo "üì¶ D√©ploiement Production termin√©"
          echo "üîó Frontend: ${{ env.FRONTEND_IMAGE }}:${{ github.sha }}"
          echo "üîó Backend: ${{ env.BACKEND_IMAGE }}:${{ github.sha }}"
          echo "üåê URL: https://mediconnet.example.com"

  # ===========================================================================
  # JOB: ROLLBACK - Retour √† la version pr√©c√©dente
  # ===========================================================================
  # Permet de revenir rapidement √† une version pr√©c√©dente en cas de probl√®me
  # D√©clench√© manuellement uniquement
  # ===========================================================================
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    # Ce job ne s'ex√©cute que manuellement via workflow_dispatch
    if: false  # D√©sactiv√© par d√©faut, activer via workflow_dispatch personnalis√©
    
    steps:
      - name: Rollback instructions
        run: |
          echo "üîÑ Pour effectuer un rollback:"
          echo "1. Identifier le tag de l'image pr√©c√©dente dans le registry"
          echo "2. Mettre √† jour docker-compose.yml avec le tag pr√©c√©dent"
          echo "3. Ex√©cuter: docker-compose pull && docker-compose up -d"
          echo ""
          echo "Ou utiliser Git pour revenir au commit pr√©c√©dent:"
          echo "git revert HEAD && git push"
